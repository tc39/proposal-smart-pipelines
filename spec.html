<pre class=metadata>
title: Smart Pipelines
status: proposal
stage: −1
location: https://github.com/js-choi/proposal-smart-pipelines
copyright: false
contributors: J. S. Choi
</pre>
<script src=ecmarkup.js defer></script>
<link rel=stylesheet href=ecmarkup.css>

<emu-intro id=introduction>
<h1>Introduction</h1>
<p>This is the formal specification for a proposed “smart pipe operator” <code>|&gt;</code> in JavaScript. <a href=https://github.com/js-choi/proposal-smart-pipelines/blob/master/readme.md>See the proposal's explainer for an introduction</a>.</p>
</emu-intro>

<emu-clause id="sec-lexical-environments">
<h1>Lexical Environments</h1>
<p>A <dfn>Lexical Environment</dfn> is a specification type used to define the association of |Identifier|s to specific variables and functions based upon the lexical nesting structure of ECMAScript code. A Lexical Environment consists of an Environment Record and a possibly null reference to an <em>outer</em> Lexical Environment. Usually a Lexical Environment is associated with some specific syntactic structure of ECMAScript code such as a |FunctionDeclaration|, a |BlockStatement|, or a |Catch| clause of a |TryStatement| and a new Lexical Environment is created each time such code is evaluated.</p>
<p>An Environment Record records the identifier bindings that are created within the scope of its associated Lexical Environment. It is referred to as the Lexical Environment's <dfn>EnvironmentRecord</dfn>.</p>
<p>The outer environment reference is used to model the logical nesting of Lexical Environment values. The outer reference of a (inner) Lexical Environment is a reference to the Lexical Environment that logically surrounds the inner Lexical Environment. An outer Lexical Environment may, of course, have its own outer Lexical Environment. A Lexical Environment may serve as the outer environment for multiple inner Lexical Environments. For example, if a |FunctionDeclaration| contains two nested |FunctionDeclaration|s then the Lexical Environments of each of the nested functions will have as their outer Lexical Environment the Lexical Environment of the current evaluation of the surrounding function.</p>
<p>A <dfn id="global-environment">global environment</dfn> is a Lexical Environment which does not have an outer environment. The global environment's outer environment reference is *null*. A global environment's EnvironmentRecord may be prepopulated with identifier bindings and includes an associated <dfn id="global-object">global object</dfn> whose properties provide some of the global environment's identifier bindings. As ECMAScript code is executed, additional properties may be added to the global object and the initial properties may be modified.</p>
<p>A <dfn id="module-environment">module environment</dfn> is a Lexical Environment that contains the bindings for the top level declarations of a |Module|. It also contains the bindings that are explicitly imported by the |Module|. The outer environment of a module environment is a global environment.</p>
<p>A <dfn id="function-environment">function environment</dfn> is a Lexical Environment that corresponds to the invocation of an ECMAScript function object. A function environment may establish a new `this` binding. A function environment also captures the state necessary to support `super` method invocations.</p>
<p>Lexical Environments and Environment Record values are purely specification mechanisms and need not correspond to any specific artefact of an ECMAScript implementation. It is impossible for an ECMAScript program to directly access or manipulate such values.</p>

<!-- es6num="8.1.1" -->
<emu-clause id="sec-environment-records">
<h1>Environment Records</h1>
<p>There are two primary kinds of <dfn>Environment Record</dfn> values used in this specification: <em>declarative Environment Records</em> and <em>object Environment Records</em>. Declarative Environment Records are used to define the effect of ECMAScript language syntactic elements such as |FunctionDeclaration|s, |VariableDeclaration|s, and |Catch| clauses that directly associate identifier bindings with ECMAScript language values. Object Environment Records are used to define the effect of ECMAScript elements such as |WithStatement| that associate identifier bindings with the properties of some object. Global Environment Records and function Environment Records are specializations that are used for specifically for |Script| global declarations and for top-level declarations within functions.</p>
<p>For specification purposes Environment Record values are values of the Record specification type and can be thought of as existing in a simple object-oriented hierarchy where Environment Record is an abstract class with three concrete subclasses, declarative Environment Record, object Environment Record, and global Environment Record. Function Environment Records and module Environment Records are subclasses of declarative Environment Record. The abstract class includes the abstract specification methods defined in <emu-xref href="#table-15"></emu-xref>. These abstract methods have distinct concrete algorithms for each of the concrete subclasses.</p>
<emu-table id="table-15" caption="Abstract Methods of Environment Records">
<table>
<tbody>
<tr>
<th>
Method
</th>
<th>
Purpose
</th>
</tr>
<tr>
<td>
HasBinding(N)
</td>
<td>
Determine if an Environment Record has a binding for the String value _N_. Return *true* if it does and *false* if it does not.
</td>
</tr>
<tr>
<td>
CreateMutableBinding(N, D)
</td>
<td>
Create a new but uninitialized mutable binding in an Environment Record. The String value _N_ is the text of the bound name. If the Boolean argument _D_ is *true* the binding may be subsequently deleted.
</td>
</tr>
<tr>
<td>
CreateImmutableBinding(N, S)
</td>
<td>
Create a new but uninitialized immutable binding in an Environment Record. The String value _N_ is the text of the bound name. If _S_ is *true* then attempts to set it after it has been initialized will always throw an exception, regardless of the strict mode setting of operations that reference that binding.
</td>
</tr>
<tr>
<td>
InitializeBinding(N, V)
</td>
<td>
Set the value of an already existing but uninitialized binding in an Environment Record. The String value _N_ is the text of the bound name. _V_ is the value for the binding and is a value of any ECMAScript language type.
</td>
</tr>
<tr>
<td>
SetMutableBinding(N, V, S)
</td>
<td>
Set the value of an already existing mutable binding in an Environment Record. The String value _N_ is the text of the bound name. _V_ is the value for the binding and may be a value of any ECMAScript language type. _S_ is a Boolean flag. If _S_ is *true* and the binding cannot be set throw a *TypeError* exception.
</td>
</tr>
<tr>
<td>
GetBindingValue(N, S)
</td>
<td>
Returns the value of an already existing binding from an Environment Record. The String value _N_ is the text of the bound name. _S_ is used to identify references originating in strict mode code or that otherwise require strict mode reference semantics. If _S_ is *true* and the binding does not exist throw a *ReferenceError* exception. If the binding exists but is uninitialized a *ReferenceError* is thrown, regardless of the value of _S_.
</td>
</tr>
<tr>
<td>
DeleteBinding(N)
</td>
<td>
Delete a binding from an Environment Record. The String value _N_ is the text of the bound name. If a binding for _N_ exists, remove the binding and return *true*. If the binding exists but cannot be removed return *false*. If the binding does not exist return *true*.
</td>
</tr>
<tr>
<td>
HasThisBinding()
</td>
<td>
Determine if an Environment Record establishes a `this` binding. Return *true* if it does and *false* if it does not.
</td>
</tr>
<tr>
<td>
HasSuperBinding()
</td>
<td>
Determine if an Environment Record establishes a `super` method binding. Return *true* if it does and *false* if it does not.
</td>
</tr>
<tr>
<td>
<ins>GetTopicBindingStatus()</ins>
</td>
<td>
<ins>Determine the status of an Environment Record's topic (`#`) binding. Return *"bound"* if it establishes a topic binding, return *"void"* if it establishes a topic-void binding, and return *"clear"* if it establishes no topic binding.</ins>
</td>
</tr>
<tr>
<td>
<ins>GetTopicBindingValue()</ins>
</td>
<td>
<ins>If the value returned by an Environment Record's GetTopicBindingStatus method is *"bound"*, return the topic value (that is, the `#` value) of an Environment Record. If the value returned by GetTopicBindingStatus is not *"bound"*, throw a *ReferenceError* exception.</ins>
</td>
</tr>
<tr>
<td>
WithBaseObject()
</td>
<td>
If this Environment Record is associated with a `with` statement, return the with object. Otherwise, return *undefined*.
</td>
</tr>
</tbody>
</table>
</emu-table>

<!-- es6num="8.1.1.1" -->
<emu-clause id="sec-declarative-environment-records">
<h1>Declarative Environment Records</h1>
<p>Each declarative Environment Record is associated with an ECMAScript program scope containing variable, constant, let, class, module, import, and/or function declarations. A declarative Environment Record binds the set of identifiers defined by the declarations contained within its scope.</p>

<p>Declarative Environment Records have the additional state fields listed in <emu-xref href="#table-61"></emu-xref>.</p>

<ins class=block>
<emu-table id="table-61" caption="Additional Fields of Declarative Environment Records">
<table>
<tbody>
<tr>
<th>
Method
</th>
<th>
Value
</th>
<th>
Purpose
</th>
</tr>
<tr>
<td>
[[TopicBindingStatus]]
</td>
<td>
Any
</td>
<td>
If the value is *"bound"*, the associated program scope binds the topic (that is, it binds `#`) to a value. If the value is *"void"*, the scope voids the topic, which hides its outer environment's topic. If the value is *"clear"*, the scope establishes neither a topic binding nor a topic-void binding.
</td>
</tr>
<tr>
<td>
[[TopicValue]]
</td>
<td>
Any
</td>
<td>
If the value of [[TopicBindingStatus]] is *"bound"*, this is the topic value (that is, the `#` value). The default value for [[TopicBindingStatus]] is *undefined*.
</td>
</tr>
</tbody>
</table>
</emu-table>

<p>Declarative Environment Records support all of the abstract methods of Environment Records listed in <emu-xref href="#table-15"></emu-xref>. In addition, declarative Environment Records support the methods listed in <emu-xref href="#table-62"></emu-xref>.</p>

<emu-table id="table-62" caption="Additional Methods of Declarative Environment Records">
<table>
<tbody>
<tr>
<th>
Method
</th>
<th>
Purpose
</th>
</tr>
<tr>
<td>
ClearTopicBinding()
</td>
<td>
Clear the topic binding of an Environment Record, which allows the topic binding (that is, the `#` binding) of its outer Lexical Environment to become visible to its inner Lexical Environment.
</td>
</tr>
<tr>
<td>
BindTopicValue(V)
</td>
<td>
Establish the topic binding (that is, the `#` binding) of an Environment Record and set the topic binding's value. _V_ is the value for the binding and is a value of any ECMAScript language type. Afterward, the value returned by the Environment Record's GetTopicBindingStatus method is *"bound"*.
</td>
</tr>
<tr>
<td>
GetTopicBindingValue()
</td>
<td>
Return the value of this Environment Record's topic binding (that is, its `#` binding). Throws a *ReferenceError* if a topic binding has not been established (that is, if the value returned by the Environment Record's GetTopicBindingValue method is *"void"* or *"clear"*).
</td>
</tr>
</tbody>
</table>
</emu-table>
</ins>

<p>The behaviour of the concrete <ins>and additional</ins> specification methods for declarative Environment Records is defined by the following algorithms.</p>

<!-- es6num="8.1.1.1.1" -->
<emu-clause id="sec-declarative-environment-records-hasbinding-n">
<h1>HasBinding ( _N_ )</h1>
<p>The concrete Environment Record method HasBinding for declarative Environment Records simply determines if the argument identifier is one of the identifiers bound by the record:</p>
<emu-alg>
1. Let _envRec_ be the declarative Environment Record for which the method was invoked.
1. If _envRec_ has a binding for the name that is the value of _N_, return *true*.
1. Return *false*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.1.2" -->
<emu-clause id="sec-declarative-environment-records-createmutablebinding-n-d">
<h1>CreateMutableBinding ( _N_, _D_ )</h1>
<p>The concrete Environment Record method CreateMutableBinding for declarative Environment Records creates a new mutable binding for the name _N_ that is uninitialized. A binding must not already exist in this Environment Record for _N_. If Boolean argument _D_ has the value *true* the new binding is marked as being subject to deletion.</p>
<emu-alg>
1. Let _envRec_ be the declarative Environment Record for which the method was invoked.
1. Assert: _envRec_ does not already have a binding for _N_.
1. Create a mutable binding in _envRec_ for _N_ and record that it is uninitialized. If _D_ is *true*, record that the newly created binding may be deleted by a subsequent DeleteBinding call.
1. Return NormalCompletion(~empty~).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.1.3" -->
<emu-clause id="sec-declarative-environment-records-createimmutablebinding-n-s">
<h1>CreateImmutableBinding ( _N_, _S_ )</h1>
<p>The concrete Environment Record method CreateImmutableBinding for declarative Environment Records creates a new immutable binding for the name _N_ that is uninitialized. A binding must not already exist in this Environment Record for _N_. If the Boolean argument _S_ has the value *true* the new binding is marked as a strict binding.</p>
<emu-alg>
1. Let _envRec_ be the declarative Environment Record for which the method was invoked.
1. Assert: _envRec_ does not already have a binding for _N_.
1. Create an immutable binding in _envRec_ for _N_ and record that it is uninitialized. If _S_ is *true*, record that the newly created binding is a strict binding.
1. Return NormalCompletion(~empty~).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.1.4" -->
<emu-clause id="sec-declarative-environment-records-initializebinding-n-v">
<h1>InitializeBinding ( _N_, _V_ )</h1>
<p>The concrete Environment Record method InitializeBinding for declarative Environment Records is used to set the bound value of the current binding of the identifier whose name is the value of the argument _N_ to the value of argument _V_. An uninitialized binding for _N_ must already exist.</p>
<emu-alg>
1. Let _envRec_ be the declarative Environment Record for which the method was invoked.
1. Assert: _envRec_ must have an uninitialized binding for _N_.
1. Set the bound value for _N_ in _envRec_ to _V_.
1. Record that the binding for _N_ in _envRec_ has been initialized.
1. Return NormalCompletion(~empty~).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.1.5" -->
<emu-clause id="sec-declarative-environment-records-setmutablebinding-n-v-s">
<h1>SetMutableBinding ( _N_, _V_, _S_ )</h1>
<p>The concrete Environment Record method SetMutableBinding for declarative Environment Records attempts to change the bound value of the current binding of the identifier whose name is the value of the argument _N_ to the value of argument _V_. A binding for _N_ normally already exists, but in rare cases it may not. If the binding is an immutable binding, a *TypeError* is thrown if _S_ is *true*.</p>
<emu-alg>
1. Let _envRec_ be the declarative Environment Record for which the method was invoked.
1. If _envRec_ does not have a binding for _N_, then
1. If _S_ is *true*, throw a *ReferenceError* exception.
1. Perform _envRec_.CreateMutableBinding(_N_, *true*).
1. Perform _envRec_.InitializeBinding(_N_, _V_).
1. Return NormalCompletion(~empty~).
1. If the binding for _N_ in _envRec_ is a strict binding, set _S_ to *true*.
1. If the binding for _N_ in _envRec_ has not yet been initialized, throw a *ReferenceError* exception.
1. Else if the binding for _N_ in _envRec_ is a mutable binding, change its bound value to _V_.
1. Else,
1. Assert: This is an attempt to change the value of an immutable binding.
1. If _S_ is *true*, throw a *TypeError* exception.
1. Return NormalCompletion(~empty~).
</emu-alg>
<emu-note>
<p>An example of ECMAScript code that results in a missing binding at step 2 is:</p>
<pre><code language="javascript">function f(){eval("var x; x = (delete x, 0);")}</code></pre>
</emu-note>
</emu-clause>

<!-- es6num="8.1.1.1.6" -->
<emu-clause id="sec-declarative-environment-records-getbindingvalue-n-s">
<h1>GetBindingValue ( _N_, _S_ )</h1>
<p>The concrete Environment Record method GetBindingValue for declarative Environment Records simply returns the value of its bound identifier whose name is the value of the argument _N_. If the binding exists but is uninitialized a *ReferenceError* is thrown, regardless of the value of _S_.</p>
<emu-alg>
1. Let _envRec_ be the declarative Environment Record for which the method was invoked.
1. Assert: _envRec_ has a binding for _N_.
1. If the binding for _N_ in _envRec_ is an uninitialized binding, throw a *ReferenceError* exception.
1. Return the value currently bound to _N_ in _envRec_.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.1.7" -->
<emu-clause id="sec-declarative-environment-records-deletebinding-n">
<h1>DeleteBinding ( _N_ )</h1>
<p>The concrete Environment Record method DeleteBinding for declarative Environment Records can only delete bindings that have been explicitly designated as being subject to deletion.</p>
<emu-alg>
1. Let _envRec_ be the declarative Environment Record for which the method was invoked.
1. Assert: _envRec_ has a binding for the name that is the value of _N_.
1. If the binding for _N_ in _envRec_ cannot be deleted, return *false*.
1. Remove the binding for _N_ from _envRec_.
1. Return *true*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.1.8" -->
<emu-clause id="sec-declarative-environment-records-hasthisbinding">
<h1>HasThisBinding ( )</h1>
<p>Regular declarative Environment Records do not provide a `this` binding.</p>
<emu-alg>
1. Return *false*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.1.9" -->
<emu-clause id="sec-declarative-environment-records-hassuperbinding">
<h1>HasSuperBinding ( )</h1>
<p>Regular declarative Environment Records do not provide a `super` binding.</p>
<emu-alg>
1. Return *false*.
</emu-alg>
</emu-clause>

<ins class=block>
<emu-clause id="sec-declarative-environment-records-gettopicbindingstatus">
<h1>GetTopicBindingStatus ( )</h1>
<p>The concrete Environment Record method GetTopicBindingStatus for declarative Environment Records Declarative Environment Records returns the value of their field [[TopicBindingStatus]], which is *"void"* by default. The value may also be *"clear"* (if the declarative Environment Record's ClearTopicBinding method has been called) or *"bound"* (if its BindTopicValue method has been called). An Environment Record with a void topic binding may change its status to *"clear"* or *"bound"* but never vice versa.</p>
<emu-alg>
1. Let _envRec_ be the function Environment Record for which the method was invoked.
2. Return _envRec_.[[TopicBindingStatus]].
</emu-alg>
</emu-clause>

<emu-clause id="sec-declarative-environment-records-gettopicbindingvalue">
<h1>GetTopicBindingValue ( )</h1>
<p>The concrete Environment Record method GetTopicBindingValue for declarative Environment Records Declarative Environment Records returns the value of their field [[TopicBindingStatus]], which is *"void"* by default. The value may also be *"clear"* (if the declarative Environment Record's ClearTopicBinding method has been called) or *"bound"* (if its BindTopicValue method has been called). An Environment Record with a void topic binding may change its status to *"clear"* or *"bound"* but never vice versa.</p>
<emu-alg>
1. Let _envRec_ be the declarative Environment Record for which the method was invoked.
2. Assert: _envRec_.[[TopicBindingStatus]] is *"bound"*.
3. Return _envRec_.[[TopicValue]].
</emu-alg>
</emu-clause>
</ins>

<!-- es6num="8.1.1.1.10" -->
<emu-clause id="sec-declarative-environment-records-withbaseobject">
<h1>WithBaseObject ( )</h1>
<p>Declarative Environment Records always return *undefined* as their WithBaseObject.</p>
<emu-alg>
1. Return *undefined*.
</emu-alg>
</emu-clause>
</emu-clause>

<!-- es6num="8.1.1.2" -->
<emu-clause id="sec-object-environment-records">
<h1>Object Environment Records</h1>
<p>Each object Environment Record is associated with an object called its <em>binding object</em>. An object Environment Record binds the set of string identifier names that directly correspond to the property names of its binding object. Property keys that are not strings in the form of an |IdentifierName| are not included in the set of bound identifiers. Both own and inherited properties are included in the set regardless of the setting of their [[Enumerable]] attribute. Because properties can be dynamically added and deleted from objects, the set of identifiers bound by an object Environment Record may potentially change as a side-effect of any operation that adds or deletes properties. Any bindings that are created as a result of such a side-effect are considered to be a mutable binding even if the Writable attribute of the corresponding property has the value *false*. Immutable bindings do not exist for object Environment Records.</p>
<p>Object Environment Records created for `with` statements (<emu-xref href="#sec-with-statement"></emu-xref>) can provide their binding object as an implicit *this* value for use in function calls. The capability is controlled by a _withEnvironment_ Boolean value that is associated with each object Environment Record. By default, the value of _withEnvironment_ is *false* for any object Environment Record.</p>
<p>The behaviour of the concrete specification methods for object Environment Records is defined by the following algorithms.</p>

<!-- es6num="8.1.1.2.1" -->
<emu-clause id="sec-object-environment-records-hasbinding-n">
<h1>HasBinding ( _N_ )</h1>
<p>The concrete Environment Record method HasBinding for object Environment Records determines if its associated binding object has a property whose name is the value of the argument _N_:</p>
<emu-alg>
1. Let _envRec_ be the object Environment Record for which the method was invoked.
1. Let _bindings_ be the binding object for _envRec_.
1. Let _foundBinding_ be ? HasProperty(_bindings_, _N_).
1. If _foundBinding_ is *false*, return *false*.
1. If the _withEnvironment_ flag of _envRec_ is *false*, return *true*.
1. Let _unscopables_ be ? Get(_bindings_, @@unscopables).
1. If Type(_unscopables_) is Object, then
1. Let _blocked_ be ToBoolean(? Get(_unscopables_, _N_)).
1. If _blocked_ is *true*, return *false*.
1. Return *true*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.2.2" -->
<emu-clause id="sec-object-environment-records-createmutablebinding-n-d">
<h1>CreateMutableBinding ( _N_, _D_ )</h1>
<p>The concrete Environment Record method CreateMutableBinding for object Environment Records creates in an Environment Record's associated binding object a property whose name is the String value and initializes it to the value *undefined*. If Boolean argument _D_ has the value *true* the new property's [[Configurable]] attribute is set to *true*; otherwise it is set to *false*.</p>
<emu-alg>
1. Let _envRec_ be the object Environment Record for which the method was invoked.
1. Let _bindings_ be the binding object for _envRec_.
1. Return ? DefinePropertyOrThrow(_bindings_, _N_, PropertyDescriptor{[[Value]]: *undefined*, [[Writable]]: *true*, [[Enumerable]]: *true*, [[Configurable]]: _D_}).
</emu-alg>
<emu-note>
<p>Normally _envRec_ will not have a binding for _N_ but if it does, the semantics of DefinePropertyOrThrow may result in an existing binding being replaced or shadowed or cause an abrupt completion to be returned.</p>
</emu-note>
</emu-clause>

<!-- es6num="8.1.1.2.3" -->
<emu-clause id="sec-object-environment-records-createimmutablebinding-n-s">
<h1>CreateImmutableBinding ( _N_, _S_ )</h1>
<p>The concrete Environment Record method CreateImmutableBinding is never used within this specification in association with object Environment Records.</p>
</emu-clause>

<!-- es6num="8.1.1.2.4" -->
<emu-clause id="sec-object-environment-records-initializebinding-n-v">
<h1>InitializeBinding ( _N_, _V_ )</h1>
<p>The concrete Environment Record method InitializeBinding for object Environment Records is used to set the bound value of the current binding of the identifier whose name is the value of the argument _N_ to the value of argument _V_. An uninitialized binding for _N_ must already exist.</p>
<emu-alg>
1. Let _envRec_ be the object Environment Record for which the method was invoked.
1. Assert: _envRec_ must have an uninitialized binding for _N_.
1. Record that the binding for _N_ in _envRec_ has been initialized.
1. Return ? _envRec_.SetMutableBinding(_N_, _V_, *false*).
</emu-alg>
<emu-note>
<p>In this specification, all uses of CreateMutableBinding for object Environment Records are immediately followed by a call to InitializeBinding for the same name. Hence, implementations do not need to explicitly track the initialization state of individual object Environment Record bindings.</p>
</emu-note>
</emu-clause>

<!-- es6num="8.1.1.2.5" -->
<emu-clause id="sec-object-environment-records-setmutablebinding-n-v-s">
<h1>SetMutableBinding ( _N_, _V_, _S_ )</h1>
<p>The concrete Environment Record method SetMutableBinding for object Environment Records attempts to set the value of the Environment Record's associated binding object's property whose name is the value of the argument _N_ to the value of argument _V_. A property named _N_ normally already exists but if it does not or is not currently writable, error handling is determined by the value of the Boolean argument _S_.</p>
<emu-alg>
1. Let _envRec_ be the object Environment Record for which the method was invoked.
1. Let _bindings_ be the binding object for _envRec_.
1. Return ? Set(_bindings_, _N_, _V_, _S_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.2.6" -->
<emu-clause id="sec-object-environment-records-getbindingvalue-n-s">
<h1>GetBindingValue ( _N_, _S_ )</h1>
<p>The concrete Environment Record method GetBindingValue for object Environment Records returns the value of its associated binding object's property whose name is the String value of the argument identifier _N_. The property should already exist but if it does not the result depends upon the value of the _S_ argument:</p>
<emu-alg>
1. Let _envRec_ be the object Environment Record for which the method was invoked.
1. Let _bindings_ be the binding object for _envRec_.
1. Let _value_ be ? HasProperty(_bindings_, _N_).
1. If _value_ is *false*, then
1. If _S_ is *false*, return the value *undefined*; otherwise throw a *ReferenceError* exception.
1. Return ? Get(_bindings_, _N_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.2.7" -->
<emu-clause id="sec-object-environment-records-deletebinding-n">
<h1>DeleteBinding ( _N_ )</h1>
<p>The concrete Environment Record method DeleteBinding for object Environment Records can only delete bindings that correspond to properties of the environment object whose [[Configurable]] attribute have the value *true*.</p>
<emu-alg>
1. Let _envRec_ be the object Environment Record for which the method was invoked.
1. Let _bindings_ be the binding object for _envRec_.
1. Return ? _bindings_.[[Delete]](_N_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.2.8" -->
<emu-clause id="sec-object-environment-records-hasthisbinding">
<h1>HasThisBinding ( )</h1>
<p>Regular object Environment Records do not provide a `this` binding.</p>
<emu-alg>
1. Return *false*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.2.9" -->
<emu-clause id="sec-object-environment-records-hassuperbinding">
<h1>HasSuperBinding ( )</h1>
<p>Regular object Environment Records do not provide a `super` binding.</p>
<emu-alg>
1. Return *false*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.2.10" -->
<emu-clause id="sec-object-environment-records-withbaseobject">
<h1>WithBaseObject ( )</h1>
<p>Object Environment Records return *undefined* as their WithBaseObject unless their _withEnvironment_ flag is *true*.</p>
<emu-alg>
1. Let _envRec_ be the object Environment Record for which the method was invoked.
1. If the _withEnvironment_ flag of _envRec_ is *true*, return the binding object for _envRec_.
1. Otherwise, return *undefined*.
</emu-alg>
</emu-clause>
</emu-clause>

<!-- es6num="8.1.1.3" -->
<emu-clause id="sec-function-environment-records">
<h1>Function Environment Records</h1>
<p>A <dfn>function Environment Record</dfn> is a declarative Environment Record that is used to represent the top-level scope of a function and, if the function is not an |ArrowFunction|, provides a `this` binding. If a function is not an |ArrowFunction| function and references `super`, its function Environment Record also contains the state that is used to perform `super` method invocations from within the function.</p>
<p>Function Environment Records have the additional state fields listed in <emu-xref href="#table-16"></emu-xref>.</p>
<emu-table id="table-16" caption="Additional Fields of Function Environment Records">
<table>
<tbody>
<tr>
<th>
  Field Name
</th>
<th>
  Value
</th>
<th>
  Meaning
</th>
</tr>
<tr>
<td>
  [[ThisValue]]
</td>
<td>
  Any
</td>
<td>
  This is the *this* value used for this invocation of the function.
</td>
</tr>
<tr>
<td>
  [[ThisBindingStatus]]
</td>
<td>
  `"lexical"` | `"initialized"` | `"uninitialized"`
</td>
<td>
  If the value is `"lexical"`, this is an |ArrowFunction| and does not have a local this value.
</td>
</tr>
<tr>
<td>
  [[FunctionObject]]
</td>
<td>
  Object
</td>
<td>
  The function object whose invocation caused this Environment Record to be created.
</td>
</tr>
<tr>
<td>
  [[HomeObject]]
</td>
<td>
  Object | *undefined*
</td>
<td>
  If the associated function has `super` property accesses and is not an |ArrowFunction|, [[HomeObject]] is the object that the function is bound to as a method. The default value for [[HomeObject]] is *undefined*.
</td>
</tr>
<tr>
<td>
  [[NewTarget]]
</td>
<td>
  Object | *undefined*
</td>
<td>
  If this Environment Record was created by the [[Construct]] internal method, [[NewTarget]] is the value of the [[Construct]] _newTarget_ parameter. Otherwise, its value is *undefined*.
</td>
</tr>
</tbody>
</table>
</emu-table>
<p>Function Environment Records support all of the declarative Environment Record methods listed in <emu-xref href="#table-15"></emu-xref> and share the same specifications for all of those methods except for HasThisBinding and HasSuperBinding. In addition, function Environment Records support the methods listed in <emu-xref href="#table-17"></emu-xref>:</p>
<emu-table id="table-17" caption="Additional Methods of Function Environment Records">
<table>
<tbody>
<tr>
<th>
  Method
</th>
<th>
  Purpose
</th>
</tr>
<tr>
<td>
  BindThisValue(V)
</td>
<td>
  Set the [[ThisValue]] and record that it has been initialized.
</td>
</tr>
<tr>
<td>
  GetThisBinding()
</td>
<td>
  Return the value of this Environment Record's `this` binding. Throws a *ReferenceError* if the `this` binding has not been initialized.
</td>
</tr>
<tr>
<td>
  GetSuperBase()
</td>
<td>
  Return the object that is the base for `super` property accesses bound in this Environment Record. The object is derived from this Environment Record's [[HomeObject]] field. The value *undefined* indicates that `super` property accesses will produce runtime errors.
</td>
</tr>
</tbody>
</table>
</emu-table>
<p>The behaviour of the additional concrete specification methods for function Environment Records is defined by the following algorithms:</p>

<!-- es6num="8.1.1.3.1" -->
<emu-clause id="sec-bindthisvalue">
<h1>BindThisValue ( _V_ )</h1>
<emu-alg>
1. Let _envRec_ be the function Environment Record for which the method was invoked.
1. Assert: _envRec_.[[ThisBindingStatus]] is not `"lexical"`.
1. If _envRec_.[[ThisBindingStatus]] is `"initialized"`, throw a *ReferenceError* exception.
1. Set _envRec_.[[ThisValue]] to _V_.
1. Set _envRec_.[[ThisBindingStatus]] to `"initialized"`.
1. Return _V_.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.3.2" -->
<emu-clause id="sec-function-environment-records-hasthisbinding">
<h1>HasThisBinding ( )</h1>
<emu-alg>
1. Let _envRec_ be the function Environment Record for which the method was invoked.
1. If _envRec_.[[ThisBindingStatus]] is `"lexical"`, return *false*; otherwise, return *true*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.3.3" -->
<emu-clause id="sec-function-environment-records-hassuperbinding">
<h1>HasSuperBinding ( )</h1>
<emu-alg>
1. Let _envRec_ be the function Environment Record for which the method was invoked.
1. If _envRec_.[[ThisBindingStatus]] is `"lexical"`, return *false*.
1. If _envRec_.[[HomeObject]] has the value *undefined*, return *false*; otherwise, return *true*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.3.4" -->
<emu-clause id="sec-function-environment-records-getthisbinding">
<h1>GetThisBinding ( )</h1>
<emu-alg>
1. Let _envRec_ be the function Environment Record for which the method was invoked.
1. Assert: _envRec_.[[ThisBindingStatus]] is not `"lexical"`.
1. If _envRec_.[[ThisBindingStatus]] is `"uninitialized"`, throw a *ReferenceError* exception.
1. Return _envRec_.[[ThisValue]].
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.3.5" -->
<emu-clause id="sec-getsuperbase">
<h1>GetSuperBase ( )</h1>
<emu-alg>
1. Let _envRec_ be the function Environment Record for which the method was invoked.
1. Let _home_ be _envRec_.[[HomeObject]].
1. If _home_ has the value *undefined*, return *undefined*.
1. Assert: Type(_home_) is Object.
1. Return ? _home_.[[GetPrototypeOf]]().
</emu-alg>
</emu-clause>
</emu-clause>

<!-- es6num="8.1.1.4" -->
<emu-clause id="sec-global-environment-records">
<h1>Global Environment Records</h1>
<p>A global Environment Record is used to represent the outer most scope that is shared by all of the ECMAScript |Script| elements that are processed in a common realm. A global Environment Record provides the bindings for built-in globals (clause <emu-xref href="#sec-global-object"></emu-xref>), properties of the global object, and for all top-level declarations (<emu-xref href="#sec-block-static-semantics-toplevellexicallyscopeddeclarations"></emu-xref>, <emu-xref href="#sec-block-static-semantics-toplevelvarscopeddeclarations"></emu-xref>) that occur within a |Script|.</p>
<p>A global Environment Record is logically a single record but it is specified as a composite encapsulating an object Environment Record and a declarative Environment Record. The object Environment Record has as its base object the global object of the associated Realm Record. This global object is the value returned by the global Environment Record's GetThisBinding concrete method. The object Environment Record component of a global Environment Record contains the bindings for all built-in globals (clause <emu-xref href="#sec-global-object"></emu-xref>) and all bindings introduced by a |FunctionDeclaration|, |GeneratorDeclaration|, |AsyncFunctionDeclaration|, |AsyncGeneratorDeclaration|, or |VariableStatement| contained in global code. The bindings for all other ECMAScript declarations in global code are contained in the declarative Environment Record component of the global Environment Record.</p>
<p>Properties may be created directly on a global object. Hence, the object Environment Record component of a global Environment Record may contain both bindings created explicitly by |FunctionDeclaration|, |GeneratorDeclaration|, |AsyncFunctionDeclaration|, |AsyncGeneratorDeclaration|, or |VariableDeclaration| declarations and bindings created implicitly as properties of the global object. In order to identify which bindings were explicitly created using declarations, a global Environment Record maintains a list of the names bound using its CreateGlobalVarBinding and CreateGlobalFunctionBinding concrete methods.</p>
<p>Global Environment Records have the additional fields listed in <emu-xref href="#table-18"></emu-xref> and the additional methods listed in <emu-xref href="#table-19"></emu-xref>.</p>
<emu-table id="table-18" caption="Additional Fields of Global Environment Records">
<table>
<tbody>
<tr>
<th>
  Field Name
</th>
<th>
  Value
</th>
<th>
  Meaning
</th>
</tr>
<tr>
<td>
  [[ObjectRecord]]
</td>
<td>
  Object Environment Record
</td>
<td>
  Binding object is the global object. It contains global built-in bindings as well as |FunctionDeclaration|, |GeneratorDeclaration|, |AsyncFunctionDeclaration|, |AsyncGeneratorDeclaration|, and |VariableDeclaration| bindings in global code for the associated realm.
</td>
</tr>
<tr>
<td>
  [[GlobalThisValue]]
</td>
<td>
  Object
</td>
<td>
  The value returned by `this` in global scope. Hosts may provide any ECMAScript Object value.
</td>
</tr>
<tr>
<td>
  [[DeclarativeRecord]]
</td>
<td>
  Declarative Environment Record
</td>
<td>
  Contains bindings for all declarations in global code for the associated realm code except for |FunctionDeclaration|, |GeneratorDeclaration|, |AsyncFunctionDeclaration|, |AsyncGeneratorDeclaration|, and |VariableDeclaration| _bindings_.
</td>
</tr>
<tr>
<td>
  [[VarNames]]
</td>
<td>
  List of String
</td>
<td>
  The string names bound by |FunctionDeclaration|, |GeneratorDeclaration|, |AsyncFunctionDeclaration|, |AsyncGeneratorDeclaration|, and |VariableDeclaration| declarations in global code for the associated realm.
</td>
</tr>
</tbody>
</table>
</emu-table>
<emu-table id="table-19" caption="Additional Methods of Global Environment Records">
<table>
<tbody>
<tr>
<th>
  Method
</th>
<th>
  Purpose
</th>
</tr>
<tr>
<td>
  GetThisBinding()
</td>
<td>
  Return the value of this Environment Record's `this` binding.
</td>
</tr>
<tr>
<td>
  HasVarDeclaration (N)
</td>
<td>
  Determines if the argument identifier has a binding in this Environment Record that was created using a |VariableDeclaration|, |FunctionDeclaration|, |GeneratorDeclaration|, |AsyncFunctionDeclaration|, or |AsyncGeneratorDeclaration|.
</td>
</tr>
<tr>
<td>
  HasLexicalDeclaration (N)
</td>
<td>
  Determines if the argument identifier has a binding in this Environment Record that was created using a lexical declaration such as a |LexicalDeclaration| or a |ClassDeclaration|.
</td>
</tr>
<tr>
<td>
  HasRestrictedGlobalProperty (N)
</td>
<td>
  Determines if the argument is the name of a global object property that may not be shadowed by a global lexical binding.
</td>
</tr>
<tr>
<td>
  CanDeclareGlobalVar (N)
</td>
<td>
  Determines if a corresponding CreateGlobalVarBinding call would succeed if called for the same argument _N_.
</td>
</tr>
<tr>
<td>
  CanDeclareGlobalFunction (N)
</td>
<td>
  Determines if a corresponding CreateGlobalFunctionBinding call would succeed if called for the same argument _N_.
</td>
</tr>
<tr>
<td>
  CreateGlobalVarBinding(N, D)
</td>
<td>
  Used to create and initialize to *undefined* a global `var` binding in the [[ObjectRecord]] component of a global Environment Record. The binding will be a mutable binding. The corresponding global object property will have attribute values appropriate for a `var`. The String value _N_ is the bound name. If _D_ is *true* the binding may be deleted. Logically equivalent to CreateMutableBinding followed by a SetMutableBinding but it allows var declarations to receive special treatment.
</td>
</tr>
<tr>
<td>
  CreateGlobalFunctionBinding(N, V, D)
</td>
<td>
  Create and initialize a global `function` binding in the [[ObjectRecord]] component of a global Environment Record. The binding will be a mutable binding. The corresponding global object property will have attribute values appropriate for a `function`. The String value _N_ is the bound name. _V_ is the initialization value. If the Boolean argument _D_ is *true* the binding may be deleted. Logically equivalent to CreateMutableBinding followed by a SetMutableBinding but it allows function declarations to receive special treatment.
</td>
</tr>
</tbody>
</table>
</emu-table>
<p>The behaviour of the concrete specification methods for global Environment Records is defined by the following algorithms.</p>

<!-- es6num="8.1.1.4.1" -->
<emu-clause id="sec-global-environment-records-hasbinding-n">
<h1>HasBinding ( _N_ )</h1>
<p>The concrete Environment Record method HasBinding for global Environment Records simply determines if the argument identifier is one of the identifiers bound by the record:</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _DclRec_ be _envRec_.[[DeclarativeRecord]].
1. If _DclRec_.HasBinding(_N_) is *true*, return *true*.
1. Let _ObjRec_ be _envRec_.[[ObjectRecord]].
1. Return ? _ObjRec_.HasBinding(_N_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.2" -->
<emu-clause id="sec-global-environment-records-createmutablebinding-n-d">
<h1>CreateMutableBinding ( _N_, _D_ )</h1>
<p>The concrete Environment Record method CreateMutableBinding for global Environment Records creates a new mutable binding for the name _N_ that is uninitialized. The binding is created in the associated DeclarativeRecord. A binding for _N_ must not already exist in the DeclarativeRecord. If Boolean argument _D_ has the value *true* the new binding is marked as being subject to deletion.</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _DclRec_ be _envRec_.[[DeclarativeRecord]].
1. If _DclRec_.HasBinding(_N_) is *true*, throw a *TypeError* exception.
1. Return _DclRec_.CreateMutableBinding(_N_, _D_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.3" -->
<emu-clause id="sec-global-environment-records-createimmutablebinding-n-s">
<h1>CreateImmutableBinding ( _N_, _S_ )</h1>
<p>The concrete Environment Record method CreateImmutableBinding for global Environment Records creates a new immutable binding for the name _N_ that is uninitialized. A binding must not already exist in this Environment Record for _N_. If the Boolean argument _S_ has the value *true* the new binding is marked as a strict binding.</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _DclRec_ be _envRec_.[[DeclarativeRecord]].
1. If _DclRec_.HasBinding(_N_) is *true*, throw a *TypeError* exception.
1. Return _DclRec_.CreateImmutableBinding(_N_, _S_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.4" -->
<emu-clause id="sec-global-environment-records-initializebinding-n-v">
<h1>InitializeBinding ( _N_, _V_ )</h1>
<p>The concrete Environment Record method InitializeBinding for global Environment Records is used to set the bound value of the current binding of the identifier whose name is the value of the argument _N_ to the value of argument _V_. An uninitialized binding for _N_ must already exist.</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _DclRec_ be _envRec_.[[DeclarativeRecord]].
1. If _DclRec_.HasBinding(_N_) is *true*, then
1. Return _DclRec_.InitializeBinding(_N_, _V_).
1. Assert: If the binding exists, it must be in the object Environment Record.
1. Let _ObjRec_ be _envRec_.[[ObjectRecord]].
1. Return ? _ObjRec_.InitializeBinding(_N_, _V_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.5" -->
<emu-clause id="sec-global-environment-records-setmutablebinding-n-v-s">
<h1>SetMutableBinding ( _N_, _V_, _S_ )</h1>
<p>The concrete Environment Record method SetMutableBinding for global Environment Records attempts to change the bound value of the current binding of the identifier whose name is the value of the argument _N_ to the value of argument _V_. If the binding is an immutable binding, a *TypeError* is thrown if _S_ is *true*. A property named _N_ normally already exists but if it does not or is not currently writable, error handling is determined by the value of the Boolean argument _S_.</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _DclRec_ be _envRec_.[[DeclarativeRecord]].
1. If _DclRec_.HasBinding(_N_) is *true*, then
1. Return _DclRec_.SetMutableBinding(_N_, _V_, _S_).
1. Let _ObjRec_ be _envRec_.[[ObjectRecord]].
1. Return ? _ObjRec_.SetMutableBinding(_N_, _V_, _S_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.6" -->
<emu-clause id="sec-global-environment-records-getbindingvalue-n-s">
<h1>GetBindingValue ( _N_, _S_ )</h1>
<p>The concrete Environment Record method GetBindingValue for global Environment Records returns the value of its bound identifier whose name is the value of the argument _N_. If the binding is an uninitialized binding throw a *ReferenceError* exception. A property named _N_ normally already exists but if it does not or is not currently writable, error handling is determined by the value of the Boolean argument _S_.</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _DclRec_ be _envRec_.[[DeclarativeRecord]].
1. If _DclRec_.HasBinding(_N_) is *true*, then
1. Return _DclRec_.GetBindingValue(_N_, _S_).
1. Let _ObjRec_ be _envRec_.[[ObjectRecord]].
1. Return ? _ObjRec_.GetBindingValue(_N_, _S_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.7" -->
<emu-clause id="sec-global-environment-records-deletebinding-n">
<h1>DeleteBinding ( _N_ )</h1>
<p>The concrete Environment Record method DeleteBinding for global Environment Records can only delete bindings that have been explicitly designated as being subject to deletion.</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _DclRec_ be _envRec_.[[DeclarativeRecord]].
1. If _DclRec_.HasBinding(_N_) is *true*, then
1. Return _DclRec_.DeleteBinding(_N_).
1. Let _ObjRec_ be _envRec_.[[ObjectRecord]].
1. Let _globalObject_ be the binding object for _ObjRec_.
1. Let _existingProp_ be ? HasOwnProperty(_globalObject_, _N_).
1. If _existingProp_ is *true*, then
1. Let _status_ be ? _ObjRec_.DeleteBinding(_N_).
1. If _status_ is *true*, then
  1. Let _varNames_ be _envRec_.[[VarNames]].
  1. If _N_ is an element of _varNames_, remove that element from the _varNames_.
1. Return _status_.
1. Return *true*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.8" -->
<emu-clause id="sec-global-environment-records-hasthisbinding">
<h1>HasThisBinding ( )</h1>
<emu-alg>
1. Return *true*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.9" -->
<emu-clause id="sec-global-environment-records-hassuperbinding">
<h1>HasSuperBinding ( )</h1>
<emu-alg>
1. Return *false*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.10" -->
<emu-clause id="sec-global-environment-records-withbaseobject">
<h1>WithBaseObject ( )</h1>
<p>Global Environment Records always return *undefined* as their WithBaseObject.</p>
<emu-alg>
1. Return *undefined*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.11" -->
<emu-clause id="sec-global-environment-records-getthisbinding">
<h1>GetThisBinding ( )</h1>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Return _envRec_.[[GlobalThisValue]].
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.12" -->
<emu-clause id="sec-hasvardeclaration">
<h1>HasVarDeclaration ( _N_ )</h1>
<p>The concrete Environment Record method HasVarDeclaration for global Environment Records determines if the argument identifier has a binding in this record that was created using a |VariableStatement| or a |FunctionDeclaration|:</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _varDeclaredNames_ be _envRec_.[[VarNames]].
1. If _varDeclaredNames_ contains _N_, return *true*.
1. Return *false*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.13" -->
<emu-clause id="sec-haslexicaldeclaration">
<h1>HasLexicalDeclaration ( _N_ )</h1>
<p>The concrete Environment Record method HasLexicalDeclaration for global Environment Records determines if the argument identifier has a binding in this record that was created using a lexical declaration such as a |LexicalDeclaration| or a |ClassDeclaration|:</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _DclRec_ be _envRec_.[[DeclarativeRecord]].
1. Return _DclRec_.HasBinding(_N_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.14" -->
<emu-clause id="sec-hasrestrictedglobalproperty">
<h1>HasRestrictedGlobalProperty ( _N_ )</h1>
<p>The concrete Environment Record method HasRestrictedGlobalProperty for global Environment Records determines if the argument identifier is the name of a property of the global object that must not be shadowed by a global lexical binding:</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _ObjRec_ be _envRec_.[[ObjectRecord]].
1. Let _globalObject_ be the binding object for _ObjRec_.
1. Let _existingProp_ be ? _globalObject_.[[GetOwnProperty]](_N_).
1. If _existingProp_ is *undefined*, return *false*.
1. If _existingProp_.[[Configurable]] is *true*, return *false*.
1. Return *true*.
</emu-alg>
<emu-note>
<p>Properties may exist upon a global object that were directly created rather than being declared using a var or function declaration. A global lexical binding may not be created that has the same name as a non-configurable property of the global object. The global property `undefined` is an example of such a property.</p>
</emu-note>
</emu-clause>

<!-- es6num="8.1.1.4.15" -->
<emu-clause id="sec-candeclareglobalvar">
<h1>CanDeclareGlobalVar ( _N_ )</h1>
<p>The concrete Environment Record method CanDeclareGlobalVar for global Environment Records determines if a corresponding CreateGlobalVarBinding call would succeed if called for the same argument _N_. Redundant var declarations and var declarations for pre-existing global object properties are allowed.</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _ObjRec_ be _envRec_.[[ObjectRecord]].
1. Let _globalObject_ be the binding object for _ObjRec_.
1. Let _hasProperty_ be ? HasOwnProperty(_globalObject_, _N_).
1. If _hasProperty_ is *true*, return *true*.
1. Return ? IsExtensible(_globalObject_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.16" -->
<emu-clause id="sec-candeclareglobalfunction">
<h1>CanDeclareGlobalFunction ( _N_ )</h1>
<p>The concrete Environment Record method CanDeclareGlobalFunction for global Environment Records determines if a corresponding CreateGlobalFunctionBinding call would succeed if called for the same argument _N_.</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _ObjRec_ be _envRec_.[[ObjectRecord]].
1. Let _globalObject_ be the binding object for _ObjRec_.
1. Let _existingProp_ be ? _globalObject_.[[GetOwnProperty]](_N_).
1. If _existingProp_ is *undefined*, return ? IsExtensible(_globalObject_).
1. If _existingProp_.[[Configurable]] is *true*, return *true*.
1. If IsDataDescriptor(_existingProp_) is *true* and _existingProp_ has attribute values {[[Writable]]: *true*, [[Enumerable]]: *true*}, return *true*.
1. Return *false*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.17" -->
<emu-clause id="sec-createglobalvarbinding">
<h1>CreateGlobalVarBinding ( _N_, _D_ )</h1>
<p>The concrete Environment Record method CreateGlobalVarBinding for global Environment Records creates and initializes a mutable binding in the associated object Environment Record and records the bound name in the associated [[VarNames]] List. If a binding already exists, it is reused and assumed to be initialized.</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _ObjRec_ be _envRec_.[[ObjectRecord]].
1. Let _globalObject_ be the binding object for _ObjRec_.
1. Let _hasProperty_ be ? HasOwnProperty(_globalObject_, _N_).
1. Let _extensible_ be ? IsExtensible(_globalObject_).
1. If _hasProperty_ is *false* and _extensible_ is *true*, then
1. Perform ? _ObjRec_.CreateMutableBinding(_N_, _D_).
1. Perform ? _ObjRec_.InitializeBinding(_N_, *undefined*).
1. Let _varDeclaredNames_ be _envRec_.[[VarNames]].
1. If _varDeclaredNames_ does not contain _N_, then
1. Append _N_ to _varDeclaredNames_.
1. Return NormalCompletion(~empty~).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.4.18" -->
<emu-clause id="sec-createglobalfunctionbinding">
<h1>CreateGlobalFunctionBinding ( _N_, _V_, _D_ )</h1>
<p>The concrete Environment Record method CreateGlobalFunctionBinding for global Environment Records creates and initializes a mutable binding in the associated object Environment Record and records the bound name in the associated [[VarNames]] List. If a binding already exists, it is replaced.</p>
<emu-alg>
1. Let _envRec_ be the global Environment Record for which the method was invoked.
1. Let _ObjRec_ be _envRec_.[[ObjectRecord]].
1. Let _globalObject_ be the binding object for _ObjRec_.
1. Let _existingProp_ be ? _globalObject_.[[GetOwnProperty]](_N_).
1. If _existingProp_ is *undefined* or _existingProp_.[[Configurable]] is *true*, then
1. Let _desc_ be the PropertyDescriptor{[[Value]]: _V_, [[Writable]]: *true*, [[Enumerable]]: *true*, [[Configurable]]: _D_}.
1. Else,
1. Let _desc_ be the PropertyDescriptor{[[Value]]: _V_ }.
1. Perform ? DefinePropertyOrThrow(_globalObject_, _N_, _desc_).
1. Record that the binding for _N_ in _ObjRec_ has been initialized.
1. Perform ? Set(_globalObject_, _N_, _V_, *false*).
1. Let _varDeclaredNames_ be _envRec_.[[VarNames]].
1. If _varDeclaredNames_ does not contain _N_, then
1. Append _N_ to _varDeclaredNames_.
1. Return NormalCompletion(~empty~).
</emu-alg>
<emu-note>
<p>Global function declarations are always represented as own properties of the global object. If possible, an existing own property is reconfigured to have a standard set of attribute values. Steps 8-9 are equivalent to what calling the InitializeBinding concrete method would do and if _globalObject_ is a Proxy will produce the same sequence of Proxy trap calls.</p>
</emu-note>
</emu-clause>
</emu-clause>

<!-- es6num="8.1.1.5" -->
<emu-clause id="sec-module-environment-records">
<h1>Module Environment Records</h1>
<p>A module Environment Record is a declarative Environment Record that is used to represent the outer scope of an ECMAScript |Module|. In additional to normal mutable and immutable bindings, module Environment Records also provide immutable import bindings which are bindings that provide indirect access to a target binding that exists in another Environment Record.</p>
<p>Module Environment Records support all of the declarative Environment Record methods listed in <emu-xref href="#table-15"></emu-xref> and share the same specifications for all of those methods except for GetBindingValue, DeleteBinding, HasThisBinding and GetThisBinding. In addition, module Environment Records support the methods listed in <emu-xref href="#table-20"></emu-xref>:</p>
<emu-table id="table-20" caption="Additional Methods of Module Environment Records">
<table>
<tbody>
<tr>
<th>
  Method
</th>
<th>
  Purpose
</th>
</tr>
<tr>
<td>
  CreateImportBinding(N, M, N2)
</td>
<td>
  Create an immutable indirect binding in a module Environment Record. The String value _N_ is the text of the bound name. _M_ is a Module Record, and _N2_ is a binding that exists in M's module Environment Record.
</td>
</tr>
<tr>
<td>
  GetThisBinding()
</td>
<td>
  Return the value of this Environment Record's `this` binding.
</td>
</tr>
</tbody>
</table>
</emu-table>
<p>The behaviour of the additional concrete specification methods for module Environment Records are defined by the following algorithms:</p>

<!-- es6num="8.1.1.5.1" -->
<emu-clause id="sec-module-environment-records-getbindingvalue-n-s">
<h1>GetBindingValue ( _N_, _S_ )</h1>
<p>The concrete Environment Record method GetBindingValue for module Environment Records returns the value of its bound identifier whose name is the value of the argument _N_. However, if the binding is an indirect binding the value of the target binding is returned. If the binding exists but is uninitialized a *ReferenceError* is thrown.</p>
<emu-alg>
1. Assert: _S_ is *true*.
1. Let _envRec_ be the module Environment Record for which the method was invoked.
1. Assert: _envRec_ has a binding for _N_.
1. If the binding for _N_ is an indirect binding, then
1. Let _M_ and _N2_ be the indirection values provided when this binding for _N_ was created.
1. Let _targetEnv_ be _M_.[[Environment]].
1. If _targetEnv_ is *undefined*, throw a *ReferenceError* exception.
1. Let _targetER_ be _targetEnv_'s EnvironmentRecord.
1. Return ? _targetER_.GetBindingValue(_N2_, *true*).
1. If the binding for _N_ in _envRec_ is an uninitialized binding, throw a *ReferenceError* exception.
1. Return the value currently bound to _N_ in _envRec_.
</emu-alg>
<emu-note>
<p>_S_ will always be *true* because a |Module| is always strict mode code.</p>
</emu-note>
</emu-clause>

<!-- es6num="8.1.1.5.2" -->
<emu-clause id="sec-module-environment-records-deletebinding-n">
<h1>DeleteBinding ( _N_ )</h1>
<p>The concrete Environment Record method DeleteBinding for module Environment Records refuses to delete bindings.</p>
<emu-alg>
1. Assert: This method is never invoked. See <emu-xref href="#sec-delete-operator-static-semantics-early-errors"></emu-xref>.
</emu-alg>
<emu-note>
<p>Module Environment Records are only used within strict code and an early error rule prevents the delete operator, in strict code, from being applied to a Reference that would resolve to a module Environment Record binding. See <emu-xref href="#sec-delete-operator-static-semantics-early-errors"></emu-xref>.</p>
</emu-note>
</emu-clause>

<!-- es6num="8.1.1.5.3" -->
<emu-clause id="sec-module-environment-records-hasthisbinding">
<h1>HasThisBinding ( )</h1>
<p>Module Environment Records provide a `this` binding.</p>
<emu-alg>
1. Return *true*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.5.4" -->
<emu-clause id="sec-module-environment-records-getthisbinding">
<h1>GetThisBinding ( )</h1>
<emu-alg>
1. Return *undefined*.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.1.5.5" -->
<emu-clause id="sec-createimportbinding">
<h1>CreateImportBinding ( _N_, _M_, _N2_ )</h1>
<p>The concrete Environment Record method CreateImportBinding for module Environment Records creates a new initialized immutable indirect binding for the name _N_. A binding must not already exist in this Environment Record for _N_. _M_ is a Module Record, and _N2_ is the name of a binding that exists in M's module Environment Record. Accesses to the value of the new binding will indirectly access the bound value of the target binding.</p>
<emu-alg>
1. Let _envRec_ be the module Environment Record for which the method was invoked.
1. Assert: _envRec_ does not already have a binding for _N_.
1. Assert: _M_ is a Module Record.
1. Assert: When _M_.[[Environment]] is instantiated it will have a direct binding for _N2_.
1. Create an immutable indirect binding in _envRec_ for _N_ that references _M_ and _N2_ as its target binding and record that the binding is initialized.
1. Return NormalCompletion(~empty~).
</emu-alg>
</emu-clause>
</emu-clause>
</emu-clause>

<!-- es6num="8.1.2" -->
<emu-clause id="sec-lexical-environment-operations">
<h1>Lexical Environment Operations</h1>
<p>The following abstract operations are used in this specification to operate upon lexical environments:</p>

<!-- es6num="8.1.2.1" -->
<emu-clause id="sec-getidentifierreference" aoid="GetIdentifierReference">
<h1>GetIdentifierReference ( _lex_, _name_, _strict_ )</h1>
<p>The abstract operation GetIdentifierReference is called with a Lexical Environment _lex_, a String _name_, and a Boolean flag _strict_. The value of _lex_ may be *null*. When called, the following steps are performed:</p>
<emu-alg>
1. If _lex_ is the value *null*, then
1. Return a value of type Reference whose base value component is *undefined*, whose referenced name component is _name_, and whose strict reference flag is _strict_.
1. Let _envRec_ be _lex_'s EnvironmentRecord.
1. Let _exists_ be ? _envRec_.HasBinding(_name_).
1. If _exists_ is *true*, then
1. Return a value of type Reference whose base value component is _envRec_, whose referenced name component is _name_, and whose strict reference flag is _strict_.
1. Else,
1. Let _outer_ be the value of _lex_'s outer environment reference.
1. Return ? GetIdentifierReference(_outer_, _name_, _strict_).
</emu-alg>
</emu-clause>

<!-- es6num="8.1.2.2" -->
<emu-clause id="sec-newdeclarativeenvironment" aoid="NewDeclarativeEnvironment">
<h1>NewDeclarativeEnvironment ( _E_ )</h1>
<p>When the abstract operation NewDeclarativeEnvironment is called with a Lexical Environment as argument _E_ the following steps are performed:</p>
<emu-alg>
1. Let _env_ be a new Lexical Environment.
1. Let _envRec_ be a new declarative Environment Record containing no bindings.
1. Set _env_'s EnvironmentRecord to _envRec_.
1. Set the outer lexical environment reference of _env_ to _E_.
1. Return _env_.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.2.3" -->
<emu-clause id="sec-newobjectenvironment" aoid="NewObjectEnvironment">
<h1>NewObjectEnvironment ( _O_, _E_ )</h1>
<p>When the abstract operation NewObjectEnvironment is called with an Object _O_ and a Lexical Environment _E_ as arguments, the following steps are performed:</p>
<emu-alg>
1. Let _env_ be a new Lexical Environment.
1. Let _envRec_ be a new object Environment Record containing _O_ as the binding object.
1. Set _env_'s EnvironmentRecord to _envRec_.
1. Set the outer lexical environment reference of _env_ to _E_.
1. Return _env_.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.2.4" -->
<emu-clause id="sec-newfunctionenvironment" aoid="NewFunctionEnvironment">
<h1>NewFunctionEnvironment ( _F_, _newTarget_ )</h1>
<p>When the abstract operation NewFunctionEnvironment is called with arguments _F_ and _newTarget_ the following steps are performed:</p>
<emu-alg>
1. Assert: _F_ is an ECMAScript function.
1. Assert: Type(_newTarget_) is Undefined or Object.
1. Let _env_ be a new Lexical Environment.
1. Let _envRec_ be a new function Environment Record containing no bindings.
1. Set _envRec_.[[FunctionObject]] to _F_.
1. If _F_.[[ThisMode]] is ~lexical~, set _envRec_.[[ThisBindingStatus]] to `"lexical"`.
1. Else, set _envRec_.[[ThisBindingStatus]] to `"uninitialized"`.
1. Let _home_ be _F_.[[HomeObject]].
1. Set _envRec_.[[HomeObject]] to _home_.
1. Set _envRec_.[[NewTarget]] to _newTarget_.
1. Set _env_'s EnvironmentRecord to _envRec_.
1. Set the outer lexical environment reference of _env_ to _F_.[[Environment]].
1. Return _env_.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.2.5" -->
<emu-clause id="sec-newglobalenvironment" aoid="NewGlobalEnvironment">
<h1>NewGlobalEnvironment ( _G_, _thisValue_ )</h1>
<p>When the abstract operation NewGlobalEnvironment is called with arguments _G_ and _thisValue_, the following steps are performed:</p>
<emu-alg>
1. Let _env_ be a new Lexical Environment.
1. Let _objRec_ be a new object Environment Record containing _G_ as the binding object.
1. Let _dclRec_ be a new declarative Environment Record containing no bindings.
1. Let _globalRec_ be a new global Environment Record.
1. Set _globalRec_.[[ObjectRecord]] to _objRec_.
1. Set _globalRec_.[[GlobalThisValue]] to _thisValue_.
1. Set _globalRec_.[[DeclarativeRecord]] to _dclRec_.
1. Set _globalRec_.[[VarNames]] to a new empty List.
1. Set _env_'s EnvironmentRecord to _globalRec_.
1. Set the outer lexical environment reference of _env_ to *null*.
1. Return _env_.
</emu-alg>
</emu-clause>

<!-- es6num="8.1.2.6" -->
<emu-clause id="sec-newmoduleenvironment" aoid="NewModuleEnvironment">
<h1>NewModuleEnvironment ( _E_ )</h1>
<p>When the abstract operation NewModuleEnvironment is called with a Lexical Environment argument _E_ the following steps are performed:</p>
<emu-alg>
1. Let _env_ be a new Lexical Environment.
1. Let _envRec_ be a new module Environment Record containing no bindings.
1. Set _env_'s EnvironmentRecord to _envRec_.
1. Set the outer lexical environment reference of _env_ to _E_.
1. Return _env_.
</emu-alg>
</emu-clause>
</emu-clause>
</emu-clause>

<emu-clause id=sec-punctuators>
<h1>Punctuators</h1>

<ins class=block>
<emu-grammar>
Punctuator :: one of
  `{` `(` `)` `[` `]` `.` `...` `;` `,` `<` `>` `<=` `>=` `==` `!=` `===` `!==` `+` `-` `*` `%` `**` `++` `--` `<<` `>>` `>>>` `&` `|` `^` `!` `~` `&&` `||` `?` `:` <ins>`|>` `#`</ins> `=` `+=` `-=` `*=` `%=` `**=` `<<=` `>>=` `>>>=` `&=` `|=` `^=` `=>`
</emu-grammar>
</ins>

<del class=block>
<emu-grammar>
Punctuator :: one of
  `{` `(` `)` `[` `]` `.` `...` `;` `,` `<` `>` `<=` `>=` `==` `!=` `===` `!==` `+` `-` `*` `%` `**` `++` `--` `<<` `>>` `>>>` `&` `|` `^` `!` `~` `&&` `||` `?` `:` `=` `+=` `-=` `*=` `%=` `**=` `<<=` `>>=` `>>>=` `&=` `|=` `^=` `=>`
</emu-grammar>
</del>

</emu-clause>

<emu-clause id=sec-primary-expression>
<h1>Primary Expression</h1>
<h2>Syntax</h2>

<emu-grammar>
PrimaryExpression[Yield, Await] :
  `this`
  <ins>`#`</ins>
  IdentifierReference[?Yield, ?Await]
  Literal
  ArrayLiteral[?Yield, ?Await]
  ObjectLiteral[?Yield, ?Await]
  FunctionExpression
  ClassExpression[?Yield, ?Await]
  GeneratorExpression
  AsyncFunctionExpression
  AsyncGeneratorExpression
  RegularExpressionLiteral
  TemplateLiteral[?Yield, ?Await, ~Tagged]
  CoverParenthesizedExpressionAndArrowParameterList[?Yield, ?Await]
</emu-grammar>

</emu-clause>

<emu-clause id=sec-assignment-operators>
<h1>Assignment Operators</h1>
<h2>Syntax</h2>

<emu-grammar>
AssignmentExpression[In, Yield, Await] :
  <del>ConditionalExpression[?In, ?Yield, ?Await]</del>
  <ins>PipelineExpression[?In, ?Yield, ?Await]</ins>
  [+Yield] YieldExpression[?In, ?Await]
  ArrowFunction[?In, ?Yield, ?Await]
  AsyncArrowFunction[?In, ?Yield, ?Await]
  LeftHandSideExpression[?Yield, ?Await] `=` AssignmentExpression[?In, ?Yield, ?Await]
  LeftHandSideExpression[?Yield, ?Await] AssignmentOperator AssignmentExpression[?In, ?Yield, ?Await]
</emu-grammar>

</emu-clause>

<ins class=block>
<emu-clause id=sec-pipeline-operator>
<h1>Pipeline Operator</h1>
<h2>Syntax</h2>

<emu-grammar>
PipelineExpression[In, Yield, Await] :
  ConditionalExpression[?In, ?Yield, ?Await]
  PipelineExpression[?In, ?Yield, ?Await] `|>` PipelineBody[?In, ?Yield, ?Await]

PipelineBody[In, Yield, Await] :
  PipelineBareFunctionCall
  PipelineBareConstructorCall
  PipelineTopicBody[?In, ?Yield, ?Await]

PipelineBareFunctionCall :
  SimpleReference

PipelineBareConstructorCall :
  `new` SimpleReference

SimpleReference :
  IdentifierReference
  SimpleReference `.` IdentifierName

PipelineTopicBody[In, Yield, Await] :
  ConditionalExpression[?In, ?Yield, ?Await]
</emu-grammar>

<emu-clause id=sec-pipeline-operator-static-semantics-contains>
<h1>Static Semantics: Contains</h1>
With parameter _symbol_.

<emu-grammar>PipelineBareFunctionCall : SimpleReference</emu-grammar>
<emu-alg>
1. If symbol is `#`, return *false*.
2. For each child node _child_ of this Parse Node, do
  1. If _child_ is an instance of _symbol_, return *true*.
  2. If _child_ is an instance of a nonterminal, then
    1. Let _contained_ be the result of _child_ Contains _symbol_.
    2. If _contained_ is *true*, return *true*.
2. Return *false*.
</emu-alg>
</emu-clause>

<emu-clause id=sec-pipeline-operator-static-semantics-early-errors>
<h1>Static Semantics: Early Errors</h1>

<emu-grammar>PipelineTopicBody : ConditionalExpression</emu-grammar>
<emu-alg>
* It is a Syntax Error if _ConditionalExpression_ Contains `#` is *false*.
* It is a Syntax Error if _ConditionalExpression_ is covering a _YieldExpression_.
</emu-alg>
</emu-clause>

<emu-clause id=sec-pipeline-operator-runtime-semantics-evaluation>
<h1>Runtime Semantics: Evaluation</h1>

<emu-grammar>PipelineExpression : PipelineExpression</emu-grammar>
<emu-alg>
1. Let _envRec_ be _env_'s Environment Record.
2. Assert: _envRec_ is a declarative Environment Record.
3. Assert: _envRec_.GetTopicBindingStatus() is *"void"*.
4. Assert: _envRec_.GetTopic() is *undefined*.
5. Perform ! _envRec_.BindTopicValue(_topic_).
</emu-alg>
</emu-clause>

<emu-clause id=sec-pipeline-operator-runtime-semantics-pipelinebodyevaluation>
<h1>Runtime Semantics: PipelineBodyEvaluation</h1>
With parameter _headValue_.

<emu-grammar>PipelineBareFunctionCall : SimpleReference</emu-grammar>
<emu-alg>
1. Let_ref_ be the result of evaluating _SimpleReference_.
2. Let_func_ be ? GetValue(_ref_).
3. Let_thisCall_ be this |PipelineBareFunctionCall|.
4. Let_tailCall_ be IsInTailPosition(_thisCall_).
5. Let_Arguments_ be a List containing the one element which is _headValue_.
6. Return ? EvaluateCall(_func_, _ref_, _Arguments_, _tailCall_).
</emu-alg>

[TODO: More body evaluations]

</emu-clause>

[TODO: Other static semantics]

</emu-clause>
</ins>

<emu-clause id=sec-arrow-function-definitions>
<h1>Arrow Function Definitions</h1>

<emu-clause id=sec-arrow-function-definitions-static-semantics-contains>
<h1>Static Semantics: Contains</h1>

<emu-grammar>ArrowFunction : ArrowParameters `=>` ConciseBody</emu-grammar>
<emu-alg>
1. If _symbol_ is not one of |NewTarget|, |SuperProperty|, |SuperCall|, <del>`super` or `this`</del> <ins>`super`, `this`, or `#`</ins>, return *false*.
2. If _ArrowParameters_ Contains _symbol_ is *true*, return *true*.
3. Return |ConciseBody| Contains _symbol_.

<emu-note>
Normally, Contains does not look inside most function forms. However, Contains is used to detect `new.target`, <ins>`this`, `super`, and `#`</ins> usage within an ArrowFunction.
</emu-note>

</emu-alg>
</emu-clause>

</emu-clause>

